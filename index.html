<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe & Meal Planner</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 { 
            color: #f5576c;
            margin-bottom: 5px;
            font-size: 2em;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 20px;
            font-size: 0.95em;
        }
        
        .nav-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .tab.active {
            color: #f5576c;
            border-bottom-color: #f5576c;
        }
        
        .tab:hover {
            color: #f5576c;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .recipe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .recipe-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .recipe-card:hover {
            transform: translateY(-3px);
            border-color: #f5576c;
            box-shadow: 0 8px 20px rgba(245, 87, 108, 0.2);
        }
        
        .recipe-name {
            font-size: 1.15em;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        
        .recipe-meta {
            display: flex;
            gap: 10px;
            color: #666;
            font-size: 0.85em;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.85em;
        }
        
        .week-planner {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }
        
        .day-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 12px;
            min-height: 350px;
        }
        
        .day-header {
            font-weight: bold;
            color: #f5576c;
            margin-bottom: 12px;
            font-size: 1em;
            text-align: center;
        }
        
        .meal-slot {
            background: white;
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 8px;
            min-height: 70px;
        }
        
        .meal-slot.filled {
            border-style: solid;
            border-color: #f5576c;
        }
        
        .meal-type {
            font-size: 0.8em;
            color: #666;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .meal-name {
            font-weight: bold;
            color: #333;
            font-size: 0.9em;
        }
        
        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        label {
            display: block;
            margin-bottom: 4px;
            color: #333;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.95em;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #f5576c;
        }
        
        .export-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
        }
        
        .export-section h3 {
            color: white;
            margin-bottom: 5px;
        }
        
        .export-section p {
            color: rgba(255,255,255,0.9);
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .apple-btn {
            background: white;
            color: #333;
            padding: 12px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.2s;
            flex: 1;
            min-width: 150px;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 0.9em;
        }
        
        .apple-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .shopping-list {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .ingredient-item {
            padding: 10px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .ingredient-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        .ingredient-item.checked label {
            text-decoration: line-through;
            color: #999;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .close-btn {
            background: #e0e0e0;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        @media (max-width: 768px) {
            h1 { font-size: 1.6em; }
            .container { padding: 15px; }
            .grid-2 { grid-template-columns: 1fr; }
            .recipe-grid { grid-template-columns: 1fr; }
            .week-planner { grid-template-columns: 1fr; }
            .export-buttons { flex-direction: column; }
            .apple-btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üç≥ Recipe & Meal Planner</h1>
        <p class="subtitle">Plan your meals and sync with Apple Calendar & Reminders</p>
        
        <div class="nav-tabs">
            <button class="tab active" onclick="showTab('recipes')">üìö Recipes</button>
            <button class="tab" onclick="showTab('planner')">üìÖ Week Planner</button>
            <button class="tab" onclick="showTab('shopping')">üõí Shopping List</button>
            <button class="tab" onclick="showTab('add')">‚ûï Add Recipe</button>
        </div>

        <!-- Recipes Tab -->
        <div id="recipes" class="tab-content active">
            <h2>My Recipe Collection</h2>
            <div id="recipeGrid" class="recipe-grid"></div>
        </div>

        <!-- Week Planner Tab -->
        <div id="planner" class="tab-content">
            <h2>This Week's Meal Plan</h2>
            <p style="color: #666; margin-bottom: 15px;" id="weekRange"></p>
            <div id="weekPlanner" class="week-planner"></div>

            <div class="export-section">
                <div>
                    <h3>üçé Export to Apple</h3>
                    <p>Sync your meal plan to Apple Calendar and shopping list to Reminders</p>
                </div>
                <div class="export-buttons">
                    <button onclick="exportToCalendar()" class="apple-btn">
                        üìÖ Export to Calendar
                    </button>
                    <button onclick="exportToReminders()" class="apple-btn">
                        ‚úÖ Export to Reminders
                    </button>
                </div>
            </div>
        </div>

        <!-- Shopping List Tab -->
        <div id="shopping" class="tab-content">
            <h2>Shopping List</h2>
            <p style="color: #666; margin-bottom: 15px;">Ingredients needed for this week's meals</p>
            <div id="shoppingList" class="shopping-list"></div>
            <div style="margin-top: 15px;">
                <button onclick="exportToReminders()" class="btn">üì≤ Export to Apple Reminders</button>
            </div>
        </div>

        <!-- Add Recipe Tab -->
        <div id="add" class="tab-content">
            <h2>Add New Recipe</h2>
            <div class="form-section">
                <form onsubmit="addRecipe(event)">
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Recipe Name</label>
                            <input type="text" id="recipeName" required>
                        </div>
                        <div class="form-group">
                            <label>Cuisine Type</label>
                            <select id="recipeCuisine" required>
                                <option value="Italian">Italian</option>
                                <option value="Asian">Asian</option>
                                <option value="Mexican">Mexican</option>
                                <option value="Mediterranean">Mediterranean</option>
                                <option value="American">American</option>
                                <option value="Indian">Indian</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Prep Time (minutes)</label>
                            <input type="number" id="recipePrepTime" required>
                        </div>
                        <div class="form-group">
                            <label>Servings</label>
                            <input type="number" id="recipeServings" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ingredients (one per line)</label>
                        <textarea id="recipeIngredients" rows="6" required placeholder="400g spaghetti&#10;200g bacon&#10;4 eggs"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Instructions (one step per line)</label>
                        <textarea id="recipeInstructions" rows="6" required placeholder="1. Boil water&#10;2. Cook pasta&#10;3. Fry bacon"></textarea>
                    </div>
                    <button type="submit" class="btn">Add Recipe</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Recipe Detail Modal -->
    <div id="recipeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalRecipeName"></h2>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>
            <div id="modalRecipeContent"></div>
        </div>
    </div>

    <!-- Meal Selection Modal -->
    <div id="mealModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Select Recipe</h2>
                <button class="close-btn" onclick="closeMealModal()">√ó</button>
            </div>
            <div id="mealModalRecipes"></div>
        </div>
    </div>

    <script>
        // Data storage
        let recipes = [];
        let mealPlan = [];
        let selectedMealSlot = null;

        // Initialize with sample data if empty
        function initializeData() {
            const stored = localStorage.getItem('mealPlannerData');
            if (stored) {
                const data = JSON.parse(stored);
                recipes = data.recipes || [];
                mealPlan = data.mealPlan || [];
            } else {
                recipes = [
                    {
                        id: Date.now() + 1,
                        name: "Avocado Toast",
                        cuisine: "American",
                        prepTime: 10,
                        servings: 2,
                        ingredients: "2 slices whole grain bread\n1 ripe avocado\n1 lemon\nSea salt\nRed pepper flakes\nCherry tomatoes (optional)\nFeta cheese (optional)",
                        instructions: "1. Toast bread until golden\n2. Mash avocado with lemon juice and salt\n3. Spread avocado on toast\n4. Top with red pepper flakes, tomatoes, and feta\n5. Serve immediately"
                    },
                    {
                        id: Date.now() + 2,
                        name: "Yogurt Parfait",
                        cuisine: "American",
                        prepTime: 5,
                        servings: 2,
                        ingredients: "2 cups Greek yogurt\n1 cup granola\n1 cup mixed berries (strawberries, blueberries, raspberries)\n2 tbsp honey\nMint leaves for garnish",
                        instructions: "1. Layer yogurt in glass or bowl\n2. Add a layer of granola\n3. Add fresh berries\n4. Repeat layers\n5. Drizzle with honey\n6. Garnish with mint"
                    },
                    {
                        id: Date.now() + 3,
                        name: "Scrambled Eggs with Toast",
                        cuisine: "American",
                        prepTime: 10,
                        servings: 2,
                        ingredients: "4 eggs\n2 tbsp butter\n2 tbsp milk\nSalt and pepper\n2 slices bread\nChives (optional)",
                        instructions: "1. Beat eggs with milk, salt, and pepper\n2. Melt butter in pan over medium heat\n3. Pour eggs and gently stir\n4. Toast bread\n5. Serve eggs on toast\n6. Garnish with chives"
                    },
                    {
                        id: Date.now() + 4,
                        name: "Spaghetti Carbonara",
                        cuisine: "Italian",
                        prepTime: 20,
                        servings: 4,
                        ingredients: "400g spaghetti\n200g pancetta\n4 eggs\n100g parmesan\nBlack pepper\nSalt",
                        instructions: "1. Cook spaghetti in salted boiling water\n2. Fry pancetta until crispy\n3. Mix eggs and parmesan in bowl\n4. Drain pasta, reserve 1 cup water\n5. Combine hot pasta with pancetta\n6. Remove from heat, add egg mixture\n7. Toss quickly, add pasta water if needed\n8. Season with black pepper"
                    },
                    {
                        id: Date.now() + 5,
                        name: "Chicken Stir Fry",
                        cuisine: "Asian",
                        prepTime: 25,
                        servings: 4,
                        ingredients: "500g chicken breast\n2 bell peppers\n1 onion\n3 tbsp soy sauce\n1 tbsp ginger (minced)\n3 cloves garlic (minced)\n2 cups mixed vegetables\n2 tbsp vegetable oil\nSesame seeds",
                        instructions: "1. Cut chicken into thin strips\n2. Heat oil in wok or large pan\n3. Stir fry chicken until golden\n4. Add garlic and ginger, cook 30 seconds\n5. Add vegetables, stir fry 5 minutes\n6. Add soy sauce and toss\n7. Garnish with sesame seeds\n8. Serve over rice"
                    },
                    {
                        id: Date.now() + 6,
                        name: "Greek Salad",
                        cuisine: "Mediterranean",
                        prepTime: 15,
                        servings: 4,
                        ingredients: "4 tomatoes\n1 cucumber\n1 red onion\n200g feta cheese\n1 cup kalamata olives\n3 tbsp olive oil\n1 tbsp red wine vinegar\nOregano\nSalt and pepper",
                        instructions: "1. Chop tomatoes and cucumber into chunks\n2. Slice red onion thinly\n3. Combine vegetables in bowl\n4. Add olives and crumbled feta\n5. Drizzle with olive oil and vinegar\n6. Season with oregano, salt, and pepper\n7. Toss gently and serve"
                    },
                    {
                        id: Date.now() + 7,
                        name: "Tacos al Pastor",
                        cuisine: "Mexican",
                        prepTime: 30,
                        servings: 4,
                        ingredients: "500g pork shoulder (thinly sliced)\n2 cups pineapple (diced)\n1 onion\nCilantro\nLimes\n8 corn tortillas\n2 tbsp chili powder\n1 tsp cumin\n2 cloves garlic",
                        instructions: "1. Marinate pork with chili powder, cumin, and garlic\n2. Cook pork in hot pan until crispy\n3. Warm tortillas\n4. Dice onion and chop cilantro\n5. Add pineapple to pork, cook 2 minutes\n6. Assemble tacos with pork, pineapple, onion, cilantro\n7. Squeeze lime juice over tacos\n8. Serve immediately"
                    },
                    {
                        id: Date.now() + 8,
                        name: "Caprese Sandwich",
                        cuisine: "Italian",
                        prepTime: 10,
                        servings: 2,
                        ingredients: "1 baguette or ciabatta\n2 large tomatoes (sliced)\n200g fresh mozzarella (sliced)\nFresh basil leaves\n2 tbsp balsamic glaze\n2 tbsp olive oil\nSalt and pepper",
                        instructions: "1. Slice bread lengthwise\n2. Drizzle olive oil on both sides\n3. Layer mozzarella and tomato slices\n4. Add fresh basil leaves\n5. Drizzle with balsamic glaze\n6. Season with salt and pepper\n7. Close sandwich and cut in half"
                    }
                ];
                saveData();
            }
        }

        function saveData() {
            localStorage.setItem('mealPlannerData', JSON.stringify({
                recipes,
                mealPlan
            }));
        }

        // Tab navigation
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'recipes') renderRecipes();
            if (tabName === 'planner') renderWeekPlanner();
            if (tabName === 'shopping') renderShoppingList();
        }

        // Recipe functions
        function addRecipe(e) {
            e.preventDefault();
            
            const recipe = {
                id: Date.now(),
                name: document.getElementById('recipeName').value,
                cuisine: document.getElementById('recipeCuisine').value,
                prepTime: parseInt(document.getElementById('recipePrepTime').value),
                servings: parseInt(document.getElementById('recipeServings').value),
                ingredients: document.getElementById('recipeIngredients').value,
                instructions: document.getElementById('recipeInstructions').value
            };
            
            recipes.push(recipe);
            saveData();
            
            e.target.reset();
            alert('Recipe added successfully!');
            showTab('recipes');
        }

        function renderRecipes() {
            const grid = document.getElementById('recipeGrid');
            
            if (recipes.length === 0) {
                grid.innerHTML = '<div class="empty-state"><p>üìù No recipes yet. Add your first recipe!</p></div>';
                return;
            }
            
            grid.innerHTML = recipes.map(recipe => `
                <div class="recipe-card" onclick="viewRecipe(${recipe.id})">
                    <div class="recipe-name">${recipe.name}</div>
                    <div class="recipe-meta">
                        <span>üåç ${recipe.cuisine}</span>
                        <span>‚è±Ô∏è ${recipe.prepTime} min</span>
                        <span>üë• ${recipe.servings}</span>
                    </div>
                    <button onclick="event.stopPropagation(); quickAddRecipe(${recipe.id})" class="btn btn-small">
                        Add to Plan
                    </button>
                </div>
            `).join('');
        }

        function viewRecipe(id) {
            const recipe = recipes.find(r => r.id === id);
            if (!recipe) return;
            
            document.getElementById('modalRecipeName').textContent = recipe.name;
            document.getElementById('modalRecipeContent').innerHTML = `
                <div style="color: #666; margin-bottom: 20px;">
                    <strong>üåç ${recipe.cuisine}</strong> ‚Ä¢ 
                    <strong>‚è±Ô∏è ${recipe.prepTime} min</strong> ‚Ä¢ 
                    <strong>üë• ${recipe.servings} servings</strong>
                </div>
                <h3 style="margin-top: 20px;">Ingredients:</h3>
                <div style="white-space: pre-wrap; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px;">${recipe.ingredients}</div>
                <h3 style="margin-top: 20px;">Instructions:</h3>
                <div style="white-space: pre-wrap; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px;">${recipe.instructions}</div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button onclick="quickAddRecipe(${recipe.id}); closeModal();" class="btn">Add to Meal Plan</button>
                    <button onclick="deleteRecipe(${recipe.id})" class="btn-secondary btn" style="background: #e74c3c;">Delete Recipe</button>
                </div>
            `;
            
            document.getElementById('recipeModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('recipeModal').classList.remove('active');
        }

        function deleteRecipe(id) {
            if (confirm('Delete this recipe?')) {
                recipes = recipes.filter(r => r.id !== id);
                mealPlan = mealPlan.filter(m => m.recipeId !== id);
                saveData();
                closeModal();
                renderRecipes();
            }
        }

        // Week planner functions
        function getWeekDates() {
            const today = new Date();
            const day = today.getDay();
            const diff = today.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(today.setDate(diff));
            
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                dates.push(date);
            }
            
            return dates;
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function renderWeekPlanner() {
            const dates = getWeekDates();
            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const mealTypes = ['Breakfast', 'Lunch', 'Dinner'];
            
            document.getElementById('weekRange').textContent = 
                `Week of ${dates[0].toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;
            
            const planner = document.getElementById('weekPlanner');
            planner.innerHTML = dates.map((date, i) => {
                const dateStr = formatDate(date);
                return `
                    <div class="day-card">
                        <div class="day-header">${dayNames[i]}<br><small>${date.getDate()}</small></div>
                        ${mealTypes.map(mealType => {
                            const meal = mealPlan.find(m => m.date === dateStr && m.mealType === mealType);
                            if (meal) {
                                const recipe = recipes.find(r => r.id === meal.recipeId);
                                return `
                                    <div class="meal-slot filled">
                                        <div class="meal-type">${mealType}</div>
                                        <div class="meal-name">${recipe ? recipe.name : 'Unknown'}</div>
                                        <button onclick="removeMeal('${dateStr}', '${mealType}')" 
                                                class="btn-secondary btn-small" style="margin-top: 5px;">
                                            Remove
                                        </button>
                                    </div>
                                `;
                            } else {
                                return `
                                    <div class="meal-slot" onclick="openMealModal('${dateStr}', '${mealType}')">
                                        <div class="meal-type">${mealType}</div>
                                        <div style="text-align: center; color: #999; font-size: 0.85em; margin-top: 10px;">
                                            + Add meal
                                        </div>
                                    </div>
                                `;
                            }
                        }).join('')}
                    </div>
                `;
            }).join('');
        }

        function quickAddRecipe(recipeId) {
            const dates = getWeekDates();
            const mealTypes = ['Breakfast', 'Lunch', 'Dinner'];
            
            for (const date of dates) {
                const dateStr = formatDate(date);
                for (const mealType of mealTypes) {
                    if (!mealPlan.find(m => m.date === dateStr && m.mealType === mealType)) {
                        mealPlan.push({ date: dateStr, mealType, recipeId });
                        saveData();
                        if (document.getElementById('planner').classList.contains('active')) {
                            renderWeekPlanner();
                        }
                        return;
                    }
                }
            }
            
            alert('Week is fully planned! Remove a meal to add this recipe.');
        }

        function openMealModal(date, mealType) {
            selectedMealSlot = { date, mealType };
            
            const modalContent = document.getElementById('mealModalRecipes');
            modalContent.innerHTML = `
                <div style="max-height: 400px; overflow-y: auto;">
                    ${recipes.map(recipe => `
                        <div class="recipe-card" onclick="addMealToPlan(${recipe.id})" 
                             style="margin-bottom: 10px;">
                            <div class="recipe-name">${recipe.name}</div>
                            <div class="recipe-meta">
                                <span>üåç ${recipe.cuisine}</span>
                                <span>‚è±Ô∏è ${recipe.prepTime} min</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('mealModal').classList.add('active');
        }

        function closeMealModal() {
            document.getElementById('mealModal').classList.remove('active');
            selectedMealSlot = null;
        }

        function addMealToPlan(recipeId) {
            if (selectedMealSlot) {
                mealPlan.push({
                    date: selectedMealSlot.date,
                    mealType: selectedMealSlot.mealType,
                    recipeId
                });
                saveData();
                renderWeekPlanner();
                closeMealModal();
            }
        }

        function removeMeal(date, mealType) {
            mealPlan = mealPlan.filter(m => !(m.date === date && m.mealType === mealType));
            saveData();
            renderWeekPlanner();
        }

        // Shopping list
        function renderShoppingList() {
            const dates = getWeekDates();
            const startDate = formatDate(dates[0]);
            const endDate = formatDate(dates[6]);
            
            const weekMeals = mealPlan.filter(m => m.date >= startDate && m.date <= endDate);
            const ingredients = new Set();
            
            weekMeals.forEach(meal => {
                const recipe = recipes.find(r => r.id === meal.recipeId);
                if (recipe) {
                    recipe.ingredients.split('\n').forEach(ing => {
                        if (ing.trim()) ingredients.add(ing.trim());
                    });
                }
            });
            
            const list = document.getElementById('shoppingList');
            
            if (ingredients.size === 0) {
                list.innerHTML = '<div class="empty-state"><p>üìã Add meals to your planner to generate a shopping list!</p></div>';
                return;
            }
            
            list.innerHTML = Array.from(ingredients).sort().map((ing, i) => `
                <div class="ingredient-item" id="ing-${i}">
                    <input type="checkbox" id="check-${i}" 
                           onchange="toggleIngredient(${i})">
                    <label for="check-${i}" style="flex: 1; cursor: pointer;">${ing}</label>
                </div>
            `).join('');
        }

        function toggleIngredient(index) {
            const item = document.getElementById(`ing-${index}`);
            item.classList.toggle('checked');
        }

        // Helper function to create date object from date string without timezone issues
        function createLocalDate(dateString, timeString) {
            const [year, month, day] = dateString.split('-').map(Number);
            const [hours, minutes, seconds] = timeString.split(':').map(Number);
            return new Date(year, month - 1, day, hours, minutes, seconds);
        }

        // Helper function to format date/time in local timezone (no UTC conversion)
        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}${month}${day}T${hours}${minutes}${seconds}`;
        }

        // Export functions
        function exportToCalendar() {
            const dates = getWeekDates();
            const startDate = formatDate(dates[0]);
            const endDate = formatDate(dates[6]);
            
            const weekMeals = mealPlan.filter(m => m.date >= startDate && m.date <= endDate);
            
            if (weekMeals.length === 0) {
                alert('No meals planned for this week. Add some meals first!');
                return;
            }
            
            const mealTimes = {
                'Breakfast': '08:00:00',
                'Lunch': '12:00:00',
                'Dinner': '18:00:00'
            };
            
            let events = [];
            
            weekMeals.forEach(meal => {
                const recipe = recipes.find(r => r.id === meal.recipeId);
                if (!recipe) return;
                
                // Create date in local timezone explicitly
                const dateTime = createLocalDate(meal.date, mealTimes[meal.mealType]);
                const endTime = new Date(dateTime.getTime() + (recipe.prepTime || 30) * 60000);
                
                // Format in local time without timezone conversion
                const dtstart = formatDateTimeLocal(dateTime);
                const dtend = formatDateTimeLocal(endTime);
                const dtstamp = new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                
                // Build event with proper line endings
                const event = [
                    'BEGIN:VEVENT',
                    `UID:${dtstart}-${recipe.name.replace(/\s+/g, '-')}@mealplanner`,
                    `DTSTAMP:${dtstamp}`,
                    `DTSTART:${dtstart}`,
                    `DTEND:${dtend}`,
                    `SUMMARY:${meal.mealType}: ${recipe.name}`,
                    `DESCRIPTION:Prep time: ${recipe.prepTime || 30} minutes`,
                    'LOCATION:Home',
                    'END:VEVENT'
                ].join('\r\n');
                
                events.push(event);
            });
            
            // Build calendar with proper line endings
            const ical = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//Meal Planner//EN',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH',
                'X-WR-CALNAME:Meal Plan',
                events.join('\r\n'),
                'END:VCALENDAR'
            ].join('\r\n');
            
            downloadFile(ical, `meal_plan_${startDate}.ics`, 'text/calendar');
        }

        function exportToReminders() {
            const dates = getWeekDates();
            const startDate = formatDate(dates[0]);
            const endDate = formatDate(dates[6]);
            
            const weekMeals = mealPlan.filter(m => m.date >= startDate && m.date <= endDate);
            const ingredients = new Set();
            
            weekMeals.forEach(meal => {
                const recipe = recipes.find(r => r.id === meal.recipeId);
                if (recipe) {
                    recipe.ingredients.split('\n').forEach(ing => {
                        if (ing.trim()) ingredients.add(ing.trim());
                    });
                }
            });
            
            if (ingredients.size === 0) {
                alert('No ingredients found. Add meals to your planner first!');
                return;
            }
            
            const now = new Date();
            const dtstamp = formatDateTimeLocal(now) + 'Z';
            
            const todos = Array.from(ingredients).map((ing, i) => {
                // Escape special characters per iCalendar spec
                const escapedIng = ing
                    .replace(/\\/g, '\\\\')
                    .replace(/\n/g, '\\n')
                    .replace(/,/g, '\\,')
                    .replace(/;/g, '\\;');
                
                // Build VTODO with proper line endings
                const todo = [
                    'BEGIN:VTODO',
                    `UID:shopping-${i}-${Date.now()}@mealplanner`,
                    `DTSTAMP:${dtstamp}`,
                    `SUMMARY:${escapedIng}`,
                    'STATUS:NEEDS-ACTION',
                    'PERCENT-COMPLETE:0',
                    'END:VTODO'
                ].join('\r\n');
                
                return todo;
            });
            
            // Build calendar with proper line endings
            const ical = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//Meal Planner//EN',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH',
                'X-WR-CALNAME:Shopping List',
                todos.join('\r\n'),
                'END:VCALENDAR'
            ].join('\r\n');
            
            downloadFile(ical, `shopping_list_${startDate}.ics`, 'text/calendar');
        }

        function downloadFile(content, filename, mimeType) {
            // Create blob with explicit charset
            const blob = new Blob([content], { type: `${mimeType};charset=utf-8` });
            
            // Check if we're on iOS/Safari
            const isIOSorSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent) || 
                                   /iPad|iPhone|iPod/.test(navigator.userAgent);
            
            if (isIOSorSafari) {
                // For Safari/iOS, use a different approach
                const reader = new FileReader();
                reader.onload = function() {
                    const url = reader.result;
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    
                    // Clean up
                    setTimeout(() => {
                        document.body.removeChild(a);
                    }, 100);
                };
                reader.readAsDataURL(blob);
            } else {
                // Standard approach for other browsers
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                
                // Clean up
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            }
            
            // Show success message
            setTimeout(() => {
                alert(`‚úÖ Downloaded ${filename}\n\nOn iPhone/iPad: Tap "Open in..." then select Calendar or Reminders.\nOn Mac: Double-click the file to import.`);
            }, 200);
        }

        // Initialize
        initializeData();
        renderRecipes();
    </script>
</body>
</html>